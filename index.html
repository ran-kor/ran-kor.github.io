<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì•„ë°œë¡  ë‚˜ë ˆì´í„°</title>
  <!-- Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css">

  <style>
    
  </style>
</head>
<body>
  <div class="container">
    <h1>ì•„ë°œë¡  ë‚˜ë ˆì´í„° by ë„í”„@ë˜ë³´ê²Œ</h1>
    <br/>
    
    
      
    <div class="row d-flex align-items-stretch">
      <div class="col-md-7 d-flex align-items-center" id="support-speech">
        <!-- <input type="text" class="form-control" id="support-speech" readonly></input> -->
      </div>
    </div>

    <div class="row d-flex align-items-stretch">
      <div class="col-md-7 d-flex align-items-center">í”Œë ˆì´ì–´ ìˆ˜</div>
      <div class="col-md-3">
        <input type="number" class="form-control" id="num_players" value=7 required>
      </div>
    </div>
  
    <div class="row">
      <div class="col-md-7 d-flex align-items-center">ë©€ë¦°íŒ€ ìˆ˜</div>
      <div class="col-md-3">
        <input type="number" class="form-control" id="num_good" value=4 required>
      </div>
    </div>
    <div class="row">
      <div class="col-md-7 d-flex align-items-center">ëª¨ë“œë ˆë“œíŒ€ ìˆ˜</div>
      <div class="col-md-3">
        <input type="number" class="form-control" id="num_evil" value=3 required>
      </div>
    </div>
    <div class="row align-items-stretch">
      
      <div class="col-md-7 d-flex align-items-center">ëŒ€ê¸°ì‹œê°„(ì´ˆ)</div>
      
      <div class="col-md-3">
        <input type="number" class="form-control" id="interval" value=5 required>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-12">
        <label>ì„ íŒ€</label><br>
        <div class="btn-group btn-group-toggle" data-toggle="buttons">
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_merlin" value="ë©€ë¦°" checked>
                ë©€ë¦°
            </label>
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_percival" value="í¼ì‹œë²Œ">
                í¼ì‹œë²Œ
            </label>
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_untrustworthy" value="ë¯¿ì—†ë¶€">
                ë¯¿ì„ ì—†ëŠ” ë¶€í•˜
            </label>
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_cleric" value="ì„±ì§ì">
                ì„±ì§ì
            </label>
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_troublemaker" value="ë§ì½ê¾¼">
                ë§ì½ê¾¼
            </label>
        </div>
    </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-12">
        <label>ì•…íŒ€</label><br>
        <div class="btn-group btn-group-toggle" data-toggle="buttons">
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_assasin" value="ì•”ì‚´ì" checked>
                ì•”ì‚´ì
            </label>
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_mordred" value="ëª¨ë“œë ˆë“œ">
                ëª¨ë“œë ˆë“œ
            </label>
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_morgana" value="ëª¨ë¥´ê°€ë‚˜">
                ëª¨ë¥´ê°€ë‚˜
            </label>
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_oberon" value="ì˜¤ë² ë¡ ">
                ì˜¤ë² ë¡ 
            </label>
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_trickster" value="ì‚¬ê¸°ê¾¼">
                ì‚¬ê¸°ê¾¼
            </label>
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_lunatic" value="ê´‘ì¸">
                ê´‘ì¸
            </label>
            <label class="btn btn-secondary btn-checkbox">
                <input type="checkbox" id="has_brute" value="í­ë ¥ë°°">
                í­ë ¥ë°°
            </label>
        </div>
    </div>
    </div>

    <div class="row">
      <div class="col-md-7 d-flex align-items-center">ì•„ì¶©ì‹  ìˆ˜</div>
      <div class="col-md-3">
        <input type="text" class="form-control" id="num_loyal_servants" value="1" readonly>
      </div>
    </div>

    <div class="row d-flex">
      <div class="col-md-3">
      <label class="btn btn-secondary btn-checkbox">
        <input type="checkbox" id="mute" value="í­ë ¥ë°°">
        ìŒì†Œê±°
      </label>
      </div>
      <!-- <div class="col-md-7 d-flex align-items-center">ìŒì†Œê±°</div>
      <div class="col-md-3">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="mute" value="ìŒì†Œê±°">
        </div>
      </div> -->
    </div>

    



    <div class="row mt-3">
      <div class="col-md-12">
        <label for="composedString">ë©˜íŠ¸:</label>
        <textarea class="form-control" id="composedString" readonly></textarea>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-md-12">
        <button class="btn btn-primary" id="composeBtn">ì‹œì‘</button>
        <button class="btn btn-danger" id="stopBtn">ì •ì§€</button>
      </div>
    </div>

  </div>

  <!-- Bootstrap 5 JS Bundle (including Popper.js) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>

    function getNumSpecials() {
      var num_special_good = 0;
      if (document.getElementById('has_merlin').checked) {
        num_special_good += 1;
      }
      if (document.getElementById('has_percival').checked) {
        num_special_good += 1;
      }
      if (document.getElementById('has_untrustworthy').checked) {
        num_special_good += 1;
      }
      if (document.getElementById('has_cleric').checked) {
        num_special_good += 1;
      }
      if (document.getElementById('has_troublemaker').checked) {
        num_special_good += 1;
      }
      return num_special_good;
    }

    function getNumSpecialEvils() {
      var num_special_evils = 0;
      if (document.getElementById('has_mordred').checked) {
        num_special_evils += 1;
      }
      if (document.getElementById('has_assasin').checked) {
        num_special_evils += 1;
      }
      if (document.getElementById('has_morgana').checked) {
        num_special_evils += 1;
      }
      if (document.getElementById('has_oberon').checked) {
        num_special_evils += 1;
      }
      if (document.getElementById('has_trickster').checked) {
        num_special_evils += 1;
      }
      if (document.getElementById('has_lunatic').checked) {
        num_special_evils += 1;
      }
      if (document.getElementById('has_brute').checked) {
        num_special_evils += 1;
      }
      return num_special_evils;
    }

    function updateNumLS() {
      var num_special_good = getNumSpecials();
      var num_good = parseInt(document.getElementById('num_good').value);
      
      var num_loyal_servants = num_good - num_special_good;
      if (num_loyal_servants < 0) {
        document.getElementById('num_loyal_servants').value = "íŠ¹ìˆ˜ì—­í• ì´ ë„ˆë¬´ ë§ì•„ìš”!";
      } else {
        document.getElementById('num_loyal_servants').value = num_loyal_servants;
      }
    }

    let utterances = [];
    let isNarrating = false;
    let stopRequested = false;

    function speakWithPause(text, lang, pauseInSeconds) {
      return new Promise(function(resolve, reject) {
        if (stopRequested) {
          resolve();
        }
        
        var muted = document.getElementById('mute').checked;
        if ('speechSynthesis' in window) {
          var synthesis = window.speechSynthesis;
          utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = lang;
          if (isNarrating) {
            document.getElementById('composedString').value = text;
            if (!muted) {
              synthesis.speak(utterance);
              utterance.onend = function() {
                setTimeout(resolve, pauseInSeconds * 1000);
              };
            } else {
              setTimeout(resolve, pauseInSeconds * 1000);
            }
          } else {
            resolve();
          }
        } else {
          resolve();
          // reject('Speech synthesis is not supported in your browser.');
        }
      });
    }

    async function speakError(text) {
      await speakWithPause(text, 'ko-KR', 0.5)
    }
    
    function checkIfSpeechSupported() {
      if ('speechSynthesis' in window) {
        // Speech Synthesis supported ğŸ‰
        document.getElementById('support-speech').innerText = 'ìŒì„± ì§€ì›ë¨ âœ…ï¸';
        return true;
      } else {
        // Speech Synthesis Not Supported ğŸ˜£
        document.getElementById('support-speech').innerText = 'ìŒì„± ì§€ì›ì•ˆë¨ âŒ';
        return false;
      }
    }
    
    async function speakSentences() {
      var num_players = parseInt(document.getElementById('num_players').value);
      var num_good = parseInt(document.getElementById('num_good').value);
      var num_evil = parseInt(document.getElementById('num_evil').value);

      var has_merlin = document.getElementById('has_merlin').checked;
      var has_percival = document.getElementById('has_percival').checked;
      var has_untrustworthy = document.getElementById('has_untrustworthy').checked;
      var has_cleric = document.getElementById('has_cleric').checked;
      var has_troublemaker = document.getElementById('has_troublemaker').checked;
      

      var has_mordred = document.getElementById('has_mordred').checked;
      var has_assasin = document.getElementById('has_assasin').checked;
      var has_morgana = document.getElementById('has_morgana').checked;
      var has_oberon = document.getElementById('has_oberon').checked;
      var has_trickster = document.getElementById('has_trickster').checked;
      var has_lunatic = document.getElementById('has_lunatic').checked;
      var has_brute = document.getElementById('has_brute').checked;

      var interval = document.getElementById('interval').value;
      var down_interval = 1;

      if (num_players != (num_good + num_evil)) {
        var msg = "í”Œë ˆì´ì–´ ìˆ˜ (" + num_players + ") ëŠ” ë©€ë¦°íŒ€ ìˆ˜ (" + num_good + ") ì™€ ëª¨ë“œë ˆë“œíŒ€ ìˆ˜ (" + num_evil + ") ì˜ í•©ê³¼ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.";
        speakError(msg);
        return;
      }

      var num_special_good = getNumSpecials();
      if (num_good - num_special_good < 0) {
        speakError("íŠ¹ìˆ˜ì—­í• ì´ ë„ˆë¬´ ë§ì•„ìš”!");
        return;
      }

      var num_special_evils = getNumSpecialEvils();
      if (num_evil != num_special_evils) {
        speakError("íŠ¹ìˆ˜ì—­í• ì´ ì—†ëŠ” ì•…ì´ ìˆì–´ìš”!");
        return;
      }
      


      var down_string = "ê³ ê°œë¥¼ ìˆ™ì—¬ì£¼ì„¸ìš”";
      await speakWithPause(down_string, 'ko-KR', interval);

  

      if (!has_merlin) {
        speakError("ë©€ë¦°ì´ ì—†ìŠµë‹ˆë‹¤");
        return;
      }

      if (!has_assasin) {
        speakError("ì•”ì‚´ìê°€ ì—†ìŠµë‹ˆë‹¤");
        return;
      }

      if (has_percival && !has_morgana) {
        speakError("ëª¨ë¥´ê°€ë‚˜ê°€ ì—†ëŠ”ë° í¼ì‹œë²Œì´ ìˆìŠµë‹ˆë‹¤");
        return;
      }

      var evil_string = "ì•… íŒ€ì€ ê³ ê°œë¥¼ ë“¤ì–´ ì„œë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
      var num_to_check_evil = num_evil;
      if (has_oberon) {
        evil_string = "ì˜¤ë² ë¡ ì„ ì œì™¸í•œ " + evil_string;
        num_to_check_evil -= 1;
      }
      evil_string += " ê³ ê°œë¥¼ ë“  ì‚¬ëŒì´ " + num_to_check_evil + "ëª…ì´ ì•„ë‹ˆë©´ ì—ëŸ¬í”Œì…ë‹ˆë‹¤."
      await speakWithPause(evil_string, 'ko-KR', interval);
      await speakWithPause(down_string, 'ko-KR', down_interval);
      
      var merlin_string = "ë©€ë¦°ì€ ê³ ê°œë¥¼ ë“¤ì–´ì£¼ì„¸ìš”. ì•”ì‚´ì";
      var prop = "ëŠ”";
      if (has_morgana) {
        merlin_string += ", ëª¨ë¥´ê°€ë‚˜";
        prop = "ëŠ”";
      }
      if (has_untrustworthy) {
        merlin_string += ", ë¯¿ì„ ìˆ˜ ì—†ëŠ” ë¶€í•˜";
        prop = "ëŠ”";
      }
      if (has_trickster) {
        merlin_string += ", ì‚¬ê¸°ê¾¼";
        prop = "ì€";
      }
      if (has_brute) {
        merlin_string += ", í­ë ¥ë°°";
        prop = "ëŠ”";
      }
      if (has_lunatic) {
        merlin_string += ", ê´‘ì¸";
        prop = "ì€";
      }
      if (has_oberon) {
        merlin_string += ", ì˜¤ë² ë¡ ";
        prop = "ì€";
      }
      merlin_string += prop + " ì—„ì§€ì†ê°€ë½ì„ ë“¤ì–´ ë©€ë¦°ì—ê²Œ ë³¸ì¸ì˜ ì¡´ì¬ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.";
      
      
      await speakWithPause(merlin_string, 'ko-KR', interval);
      await speakWithPause(down_string, 'ko-KR', down_interval);

      if (has_percival) {
        var percival_string = "í¼ì‹œë²Œì€ ê³ ê°œë¥¼ ë“¤ì–´ì£¼ì„¸ìš”. ë©€ë¦°ê³¼ ëª¨ë¥´ê°€ë‚˜";
        percival_string += "ëŠ” ì—„ì§€ì†ê°€ë½ì„ ë“¤ì–´ í¼ì‹œë²Œì—ê²Œ ë³¸ì¸ì˜ ì¡´ì¬ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.";
        await speakWithPause(percival_string, 'ko-KR', interval);
        await speakWithPause(down_string, 'ko-KR', down_interval);
      }

      if (has_untrustworthy) {
        var untrustworthy_string = "ë¯¿ì„ ìˆ˜ ì—†ëŠ” ë¶€í•˜ëŠ” ê³ ê°œë¥¼ ë“¤ì–´ì£¼ì„¸ìš”. ì•”ì‚´ìëŠ” ì—„ì§€ì†ê°€ë½ì„ ë“¤ì–´ ë¯¿ì„ ìˆ˜ ì—†ëŠ” ë¶€í•˜ì—ê²Œ ë³¸ì¸ì˜ ì¡´ì¬ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.";
        await speakWithPause(untrustworthy_string, 'ko-KR', interval);
        await speakWithPause(down_string, 'ko-KR', down_interval);
      }

      if (has_cleric) {
        var cleric_string = "ì„±ì§ìëŠ” ê³ ê°œë¥¼ ë“¤ì–´ì£¼ì„¸ìš”. ì²« ì›ì •ëŒ€ì¥ì€ ì•…ì¼ ê²½ìš° ì—„ì§€ì†ê°€ë½ì„ ë“¤ì–´ ì„±ì§ìì—ê²Œ ë³¸ì¸ì´ ì•…ì„ì„ ì•Œë ¤ì£¼ì„¸ìš”.";
        if (has_trickster) {
          cleric_string += " ì‚¬ê¸°ê¾¼ì€ ì—„ì§€ì†ê°€ë½ì„ ë“¤ì–´ë„ ë˜ê³  ì•ˆë“¤ì–´ë„ ë©ë‹ˆë‹¤."
        }
        if (has_troublemaker) {
          cleric_string += " ë§ì½ê¾¼ì€ ì„ ì´ì§€ë§Œ ì—„ì§€ì†ê°€ë½ì„ ë°˜ë“œì‹œ ë“¤ì–´ì•¼ í•©ë‹ˆë‹¤."
        }
        await speakWithPause(cleric_string, 'ko-KR', interval);
        await speakWithPause(down_string, 'ko-KR', down_interval);
      }

      var begin_string = "ì´ì œ ì…‹ì„ ì„¸ë©´ ëª¨ë‘ ê³ ê°œë¥¼ ë“¤ê³  ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.";
      await speakWithPause(begin_string, 'ko-KR', 2);
      await speakWithPause("ì…‹", 'ko-KR', 0.5);

      if(stopRequested == true) {
        document.getElementById('composedString').value = "ì •ì§€ì™„ë£Œ";
      }
      stopRequested = false;
      return;


    };
    document.addEventListener('DOMContentLoaded', checkIfSpeechSupported);
    document.getElementById('num_good').addEventListener('input', updateNumLS);
    var checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', updateNumLS);
    });
    document.getElementById('composeBtn').addEventListener('click', async function() {
    if (!isNarrating && !stopRequested) {
      isNarrating = true; // Set narration state to true before starting narration
      await speakSentences();
      isNarrating = false; // Set narration state back to false after narration is done
    }
    });
    document.getElementById('stopBtn').addEventListener('click', function() {
      var synthesis = window.speechSynthesis;
      utterances.forEach(function(utterance) {
        synthesis.cancel(); // Stop all scheduled utterances
      });
      stopRequested = true;
      document.getElementById('composedString').value = "ì •ì§€ ìš”ì²­ë¨";
    });
  </script>
</body>
</html>
